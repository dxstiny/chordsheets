import{q as O,r as p,s as P,v as U,d as E,u as I,o as w,c as S,a as s,b as v,F as K,i as B,t as $,g as F,_ as x,x as j,y as J,e as H,k as q,z,m as G}from"./main-DSnlyUdv.js";import{M as W}from"./MinWidth-qR36hj4s.js";import{E as Y}from"./Editor-f39PkB-a.js";import{I as C}from"./IconButton-BdeipojU.js";import{T as N}from"./TextInput-p-bbAW5u.js";import"./vuedraggable.umd-DbPxORnL.js";/* empty css                                                               */import"./dom-to-image-cKgm5kKk.js";/* empty css                                                                   */const M="chordsheets.history",Q=O("history",()=>{const o=p(JSON.parse(localStorage.getItem(M)||"[]")),u=P(()=>JSON.stringify(o.value));return U(o,()=>{localStorage.setItem(M,u.value)},{deep:!0}),{history:o,songEdited:n=>{const i=new Date().toISOString();o.value=[{songId:n,date:i},...o.value.filter(m=>m.songId!==n).slice(0,9)]}}}),X="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",V="https://api.spotify.com/v1";let _=null;const Z=async()=>{if(_)return _;const a=await fetch(X);if(!a.ok)throw new Error("Could not fetch token");return _=await a.text(),_},A=async()=>({Authorization:`Bearer ${await Z()}`}),ee=async a=>(await fetch(`${V}/tracks/${a}`,{headers:await A()})).json(),te=async a=>(await fetch(`${V}/audio-features/${a}`,{headers:await A()})).json(),oe=a=>{const o={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},u={0:"",1:"m"};return`${o[a.key]}${u[a.mode]}`},se=async a=>{var l,n;const[o,u]=await Promise.all([ee(a),te(a)]);return{cover:(n=(l=o.album.images)==null?void 0:l[0])==null?void 0:n.url,name:o.name,artist:o.artists[0].name,album:o.album.name,href:o.external_urls.spotify,key:oe(u),tempo:Math.round(u.tempo)}},ne=a=>{const o=a.match(/track\/(\w+)/);if(!o)throw new Error("Invalid URL");return o[1]},ae={class:"row"},re={key:0,class:"changes"},le={class:"content"},ie={class:"material-symbols-rounded"},ue={class:"muted from"},de=["onClick"],ce={class:"actions"},pe=E({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(a,{expose:o}){I();const u=p(),l=p(),n=p({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),i=a,m=()=>{u.value.showModal(),f()},f=async()=>{i.song.spotify&&(l.value=await se(ne(i.song.spotify)),l.value&&(n.value.artist={from:i.song.artist,to:l.value.artist},n.value.title={from:i.song.title,to:l.value.name},n.value.bpm={from:i.song.bpm,to:l.value.tempo},n.value.key={from:i.song.key,to:l.value.key},n.value.cover={from:i.song.cover,to:l.value.cover??""}))},c=t=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[t]??t,g=()=>{for(const t in n.value)i.song[t]=n.value[t].to},h=()=>{g(),u.value.close()};return o({show:m}),(t,d)=>(w(),S("dialog",{ref_key:"modal",ref:u},[d[4]||(d[4]=s("h1",null,"Link Spotify",-1)),s("div",null,[s("div",ae,[v(N,{label:"Spotify URI",modelValue:a.song.spotify,"onUpdate:modelValue":d[0]||(d[0]=k=>a.song.spotify=k),onChange:f},null,8,["modelValue"]),s("span",{onClick:f,class:"material-symbols-rounded"}," refresh ")]),l.value?(w(),S("div",re,[d[3]||(d[3]=s("h3",null,"Changes",-1)),s("div",le,[(w(!0),S(K,null,B(n.value,(k,y)=>(w(),S(K,null,[s("span",ie,$(c(y)),1),s("span",ue,$(k.from),1),d[2]||(d[2]=s("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),v(N,{class:"to",modelValue:n.value[y].to,"onUpdate:modelValue":b=>n.value[y].to=b,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),s("span",{onClick:b=>delete n.value[y],class:"material-symbols-rounded"}," close ",8,de)],64))),256))])])):F("",!0)]),s("div",ce,[v(C,{label:"Cancel",icon:"close",style:"red",onClick:d[1]||(d[1]=k=>u.value.close())}),v(C,{label:"Confirm",icon:"done",onClick:h,disabled:!l.value},null,8,["disabled"])])],512))}}),me=x(pe,[["__scopeId","data-v-a28d277d"]]),fe={class:"actions"},ve=E({__name:"CleanupEmptySong",props:{song:{type:Object,required:!0}},emits:["close"],setup(a,{expose:o,emit:u}){const l=I(),n=p(),i=u,m=a,f=()=>{n.value.showModal()},c=()=>{n.value.close(),i("close")},g=()=>{l.removeSong(m.song),c()};return o({show:f}),(h,t)=>(w(),S("dialog",{ref_key:"modal",ref:n},[t[1]||(t[1]=s("h1",null,"Keep Song",-1)),t[2]||(t[2]=s("div",null,[s("p",null," You don't appear to have any content in this song. Do you want to keep it? ")],-1)),s("div",fe,[v(C,{label:"Keep it",icon:"done",style:"green",onClick:t[0]||(t[0]=d=>c())}),v(C,{label:"Remove it",icon:"delete",style:"red",onClick:g})])],512))}}),ye=x(ve,[["__scopeId","data-v-277a352e"]]),ge={class:"editor_container"},ke={class:"toolbar"},we=E({__name:"index",setup(a){const o=I(),u=Q(),l=z(),n=G();let i=l.params.id;const m=p(),f=p(),c=p(!1),g=p();if(!i){const e=o.addEmptySong();n.push({path:`/editor/${e}`,replace:!0}),i=String(e)}const h=o.song(i);h||n.push("/");const t=p(h),d=()=>!(t.value.artist||t.value.title||t.value.instruments.length||t.value.sections.length||t.value.structure.length),k=()=>{var e;if(d()){(e=g.value)==null||e.show();return}n.back()},y=async()=>{await o.prepareRender();const e=await m.value.render();e&&(e.autoPrint(),window.open(e.output("bloburl"),"_blank"))},b=async()=>{await o.prepareRender();const e=await m.value.render();e&&e.save(`${t.value.title}.pdf`)},D=()=>{if(!t.value)return;const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t.value)),r=document.createElement("a");r.setAttribute("href",e),r.setAttribute("download",`${t.value.title}.chordsheets.json`),document.body.appendChild(r),r.click(),r.remove()},L=e=>{e.ctrlKey&&e.key==="s"?(e.preventDefault(),D()):e.ctrlKey&&e.shiftKey&&e.key==="S"?(e.preventDefault(),b()):e.ctrlKey&&e.key==="p"?(e.preventDefault(),y()):e.ctrlKey&&e.shiftKey&&e.key==="P"&&(e.preventDefault(),c.value=!c.value)};return j(()=>{window.addEventListener("keydown",L),u.songEdited(t.value.id),console.log("showing link spotify",t.value.spotify,t.value.title),t.value.spotify&&!t.value.title&&setTimeout(()=>{var e;return(e=f.value)==null?void 0:e.show()},100)}),J(()=>{window.removeEventListener("keydown",L)}),(e,r)=>(w(),H(W,{minWidth:300},{default:q(()=>[v(me,{ref_key:"linkSpotify",ref:f,song:t.value},null,8,["song"]),v(ye,{ref_key:"cleanupEmptySong",ref:g,song:t.value,onClose:r[0]||(r[0]=R=>e.$router.push("/browse"))},null,8,["song"]),s("div",ge,[s("a",{onClick:k,class:"back-button"},r[3]||(r[3]=[s("span",{class:"material-symbols-rounded"},"arrow_back",-1)])),s("div",ke,[s("span",{class:"material-symbols-rounded",onClick:y,title:"Print (Ctrl+P)"}," print "),s("span",{class:"material-symbols-rounded",onClick:b,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),s("span",{class:"material-symbols-rounded",onClick:D,title:"Download as JSON (CTRL+S)"}," file_download "),r[4]||(r[4]=s("div",{class:"divider"},null,-1)),s("span",{class:"material-symbols-rounded",onClick:r[1]||(r[1]=R=>{var T;return(T=f.value)==null?void 0:T.show()}),title:"Link Spotify"}," link "),r[5]||(r[5]=s("div",{class:"divider"},null,-1)),s("span",{class:"material-symbols-rounded",onClick:r[2]||(r[2]=R=>c.value=!c.value),title:"Preview (CTRL+SHIFT+P)"},$(c.value?"preview_off":"preview"),1)]),v(Y,{ref_key:"editor",ref:m,song:t.value,printing:c.value},null,8,["song","printing"])])]),_:1}))}}),De=x(we,[["__scopeId","data-v-4327c76f"]]);export{De as default};
