import{d as D,x as E,r as f,e as _,c as w,a as s,z as p,F as S,i as B,t as I,g as F,p as R,h as V,_ as A,D as K,E as M,o as N,y as P,G as j,f as O,A as $}from"./main-c2d8d01d.js";import{M as G}from"./MinWidth-9fc77078.js";import{E as z}from"./Editor-53261a49.js";import{I as x}from"./IconButton-dc425cba.js";import{T as L}from"./dom-to-image-149296d9.js";import"./_commonjsHelpers-042e6b4d.js";const J="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",U="https://api.spotify.com/v1";let g=null;const W=async()=>{if(g)return g;const t=await fetch(J);if(!t.ok)throw new Error("Could not fetch token");return g=await t.text(),g},T=async()=>({Authorization:`Bearer ${await W()}`}),q=async t=>(await fetch(`${U}/tracks/${t}`,{headers:await T()})).json(),H=async t=>(await fetch(`${U}/audio-features/${t}`,{headers:await T()})).json(),Q=t=>{const o={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},a={0:"",1:"m"};return`${o[t.key]}${a[t.mode]}`},X=async t=>{var i,n;const[o,a]=await Promise.all([q(t),H(t)]);return{cover:(n=(i=o.album.images)==null?void 0:i[0])==null?void 0:n.url,name:o.name,artist:o.artists[0].name,album:o.album.name,href:o.external_urls.spotify,key:Q(a),tempo:Math.round(a.tempo)}},Y=t=>{const o=t.match(/track\/(\w+)/);if(!o)throw new Error("Invalid URL");return o[1]},b=t=>(R("data-v-a28d277d"),t=t(),V(),t),Z=b(()=>s("h1",null,"Link Spotify",-1)),ee={class:"row"},te={key:0,class:"changes"},oe=b(()=>s("h3",null,"Changes",-1)),se={class:"content"},ne={class:"material-symbols-rounded"},ae={class:"muted from"},re=b(()=>s("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),le=["onClick"],ie={class:"actions"},ce=D({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(t,{expose:o}){const a=t;E();const i=f(),n=f(),r=f({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),v=()=>{i.value.showModal(),m()},m=async()=>{a.song.spotify&&(n.value=await X(Y(a.song.spotify)),n.value&&(r.value.artist={from:a.song.artist,to:n.value.artist},r.value.title={from:a.song.title,to:n.value.name},r.value.bpm={from:a.song.bpm,to:n.value.tempo},r.value.key={from:a.song.key,to:n.value.key},r.value.cover={from:a.song.cover,to:n.value.cover??""}))},d=c=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[c]??c,y=()=>{for(const c in r.value)a.song[c]=r.value[c].to},h=()=>{y(),i.value.close()};return o({show:v}),(c,u)=>(_(),w("dialog",{ref_key:"modal",ref:i},[Z,s("div",null,[s("div",ee,[p(L,{label:"Spotify URI",modelValue:t.song.spotify,"onUpdate:modelValue":u[0]||(u[0]=e=>t.song.spotify=e),onChange:m},null,8,["modelValue"]),s("span",{onClick:m,class:"material-symbols-rounded"}," refresh ")]),n.value?(_(),w("div",te,[oe,s("div",se,[(_(!0),w(S,null,B(r.value,(e,l)=>(_(),w(S,null,[s("span",ne,I(d(l)),1),s("span",ae,I(e.from),1),re,p(L,{class:"to",modelValue:r.value[l].to,"onUpdate:modelValue":k=>r.value[l].to=k,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),s("span",{onClick:k=>delete r.value[l],class:"material-symbols-rounded"}," close ",8,le)],64))),256))])])):F("",!0)]),s("div",ie,[p(x,{label:"Cancel",icon:"close",style:"red",onClick:u[1]||(u[1]=e=>i.value.close())}),p(x,{label:"Confirm",icon:"done",onClick:h,disabled:!n.value},null,8,["disabled"])])],512))}});const de=A(ce,[["__scopeId","data-v-a28d277d"]]),ue=t=>(R("data-v-0046c2e1"),t=t(),V(),t),pe={class:"editor_container"},me=ue(()=>s("span",{class:"material-symbols-rounded"},"arrow_back",-1)),fe={class:"toolbar"},_e=D({__name:"index",setup(t){const o=E(),a=K(),i=M();let n=a.params.id;const r=f(),v=f();if(!n){const e=o.addEmptySong();i.push({path:`/editor/${e}`,replace:!0}),n=String(e)}const m=o.song(n);m||i.push("/");const d=f(m),y=async()=>{await o.prepareRender();const e=await r.value.render();e&&(e.autoPrint(),window.open(e.output("bloburl"),"_blank"))},h=async()=>{await o.prepareRender();const e=await r.value.render();e&&e.save(`${d.value.title}.pdf`)},c=()=>{if(!d.value)return;const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d.value)),l=document.createElement("a");l.setAttribute("href",e),l.setAttribute("download",`${d.value.title}.chordsheets.json`),document.body.appendChild(l),l.click(),l.remove()},u=e=>{e.ctrlKey&&e.key==="s"?(e.preventDefault(),c()):e.ctrlKey&&e.shiftKey&&e.key==="S"?(e.preventDefault(),h()):e.ctrlKey&&e.key==="p"&&(e.preventDefault(),y())};return N(()=>{window.addEventListener("keydown",u)}),P(()=>{window.removeEventListener("keydown",u)}),(e,l)=>{const k=j("router-link");return _(),O(G,{minWidth:300},{default:$(()=>[p(de,{ref_key:"linkSpotify",ref:v,song:d.value},null,8,["song"]),s("div",pe,[p(k,{to:"/",class:"back-button"},{default:$(()=>[me]),_:1}),s("div",fe,[s("span",{class:"material-symbols-rounded",onClick:y,title:"Print (Ctrl+P)"}," print "),s("span",{class:"material-symbols-rounded",onClick:h,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),s("span",{class:"material-symbols-rounded",onClick:c,title:"Download as JSON (CTRL+S)"}," file_download "),s("span",{class:"material-symbols-rounded",onClick:l[0]||(l[0]=ve=>{var C;return(C=v.value)==null?void 0:C.show()}),title:"Link Spotify"}," link ")]),p(z,{ref_key:"editor",ref:r,song:d.value},null,8,["song"])])]),_:1})}}});const Ce=A(_e,[["__scopeId","data-v-0046c2e1"]]);export{Ce as default};
