import{a as D,u as E,r as f,f as v,g as w,h as n,p,F as S,j as T,t as I,l as F,q as R,s as V,_ as A,o as K,e as M,A as N,y as $,C as j,b as P,B as O}from"./main-xqxsP662.js";import{M as q}from"./MinWidth-BeTqPmRr.js";import{E as G}from"./Editor-Rl5G1BeX.js";import{I as x}from"./IconButton-C3-LUI-H.js";import{T as L}from"./dom-to-image-DIqK-UZv.js";import"./_commonjsHelpers-C4iS2aBk.js";const J="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",U="https://api.spotify.com/v1";let g=null;const W=async()=>{if(g)return g;const t=await fetch(J);if(!t.ok)throw new Error("Could not fetch token");return g=await t.text(),g},B=async()=>({Authorization:`Bearer ${await W()}`}),z=async t=>(await fetch(`${U}/tracks/${t}`,{headers:await B()})).json(),H=async t=>(await fetch(`${U}/audio-features/${t}`,{headers:await B()})).json(),Q=t=>{const o={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},i={0:"",1:"m"};return`${o[t.key]}${i[t.mode]}`},X=async t=>{var a,s;const[o,i]=await Promise.all([z(t),H(t)]);return{cover:(s=(a=o.album.images)==null?void 0:a[0])==null?void 0:s.url,name:o.name,artist:o.artists[0].name,album:o.album.name,href:o.external_urls.spotify,key:Q(i),tempo:Math.round(i.tempo)}},Y=t=>{const o=t.match(/track\/(\w+)/);if(!o)throw new Error("Invalid URL");return o[1]},b=t=>(R("data-v-a28d277d"),t=t(),V(),t),Z=b(()=>n("h1",null,"Link Spotify",-1)),ee={class:"row"},te={key:0,class:"changes"},oe=b(()=>n("h3",null,"Changes",-1)),se={class:"content"},ne={class:"material-symbols-rounded"},ae={class:"muted from"},re=b(()=>n("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),le=["onClick"],ie={class:"actions"},ce=D({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(t,{expose:o}){E();const i=f(),a=f(),s=f({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),l=t,y=()=>{i.value.showModal(),m()},m=async()=>{l.song.spotify&&(a.value=await X(Y(l.song.spotify)),a.value&&(s.value.artist={from:l.song.artist,to:a.value.artist},s.value.title={from:l.song.title,to:a.value.name},s.value.bpm={from:l.song.bpm,to:a.value.tempo},s.value.key={from:l.song.key,to:a.value.key},s.value.cover={from:l.song.cover,to:a.value.cover??""}))},d=c=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[c]??c,_=()=>{for(const c in s.value)l.song[c]=s.value[c].to},h=()=>{_(),i.value.close()};return o({show:y}),(c,u)=>(v(),w("dialog",{ref_key:"modal",ref:i},[Z,n("div",null,[n("div",ee,[p(L,{label:"Spotify URI",modelValue:t.song.spotify,"onUpdate:modelValue":u[0]||(u[0]=e=>t.song.spotify=e),onChange:m},null,8,["modelValue"]),n("span",{onClick:m,class:"material-symbols-rounded"}," refresh ")]),a.value?(v(),w("div",te,[oe,n("div",se,[(v(!0),w(S,null,T(s.value,(e,r)=>(v(),w(S,null,[n("span",ne,I(d(r)),1),n("span",ae,I(e.from),1),re,p(L,{class:"to",modelValue:s.value[r].to,"onUpdate:modelValue":k=>s.value[r].to=k,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),n("span",{onClick:k=>delete s.value[r],class:"material-symbols-rounded"}," close ",8,le)],64))),256))])])):F("",!0)]),n("div",ie,[p(x,{label:"Cancel",icon:"close",style:"red",onClick:u[1]||(u[1]=e=>i.value.close())}),p(x,{label:"Confirm",icon:"done",onClick:h,disabled:!a.value},null,8,["disabled"])])],512))}}),de=A(ce,[["__scopeId","data-v-a28d277d"]]),ue=t=>(R("data-v-0046c2e1"),t=t(),V(),t),pe={class:"editor_container"},me=ue(()=>n("span",{class:"material-symbols-rounded"},"arrow_back",-1)),fe={class:"toolbar"},ve=D({__name:"index",setup(t){const o=E(),i=j(),a=P();let s=i.params.id;const l=f(),y=f();if(!s){const e=o.addEmptySong();a.push({path:`/editor/${e}`,replace:!0}),s=String(e)}const m=o.song(s);m||a.push("/");const d=f(m),_=async()=>{await o.prepareRender();const e=await l.value.render();e&&(e.autoPrint(),window.open(e.output("bloburl"),"_blank"))},h=async()=>{await o.prepareRender();const e=await l.value.render();e&&e.save(`${d.value.title}.pdf`)},c=()=>{if(!d.value)return;const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d.value)),r=document.createElement("a");r.setAttribute("href",e),r.setAttribute("download",`${d.value.title}.chordsheets.json`),document.body.appendChild(r),r.click(),r.remove()},u=e=>{e.ctrlKey&&e.key==="s"?(e.preventDefault(),c()):e.ctrlKey&&e.shiftKey&&e.key==="S"?(e.preventDefault(),h()):e.ctrlKey&&e.key==="p"&&(e.preventDefault(),_())};return K(()=>{window.addEventListener("keydown",u)}),M(()=>{window.removeEventListener("keydown",u)}),(e,r)=>{const k=O("router-link");return v(),N(q,{minWidth:300},{default:$(()=>[p(de,{ref_key:"linkSpotify",ref:y,song:d.value},null,8,["song"]),n("div",pe,[p(k,{to:"/",class:"back-button"},{default:$(()=>[me]),_:1}),n("div",fe,[n("span",{class:"material-symbols-rounded",onClick:_,title:"Print (Ctrl+P)"}," print "),n("span",{class:"material-symbols-rounded",onClick:h,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),n("span",{class:"material-symbols-rounded",onClick:c,title:"Download as JSON (CTRL+S)"}," file_download "),n("span",{class:"material-symbols-rounded",onClick:r[0]||(r[0]=ye=>{var C;return(C=y.value)==null?void 0:C.show()}),title:"Link Spotify"}," link ")]),p(G,{ref_key:"editor",ref:l,song:d.value},null,8,["song"])])]),_:1})}}}),Ce=A(ve,[["__scopeId","data-v-0046c2e1"]]);export{Ce as default};
