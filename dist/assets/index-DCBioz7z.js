import{d as I,a as E,r as u,o as g,b,e as o,g as p,F as A,f as N,t as $,j as O,p as x,q as D,_ as L,x as H,y as q,h as z,w as G,z as J,l as W}from"./main-CFTRWoaP.js";import{u as Y}from"./history-CG4E6KDr.js";import{M as Q}from"./MinWidth-BAatWkSQ.js";import{E as X}from"./Editor-BKPD_i1z.js";import{I as C}from"./IconButton-Dns8PT7Y.js";import{T as B}from"./TextInput-daAmcUed.js";import"./vuedraggable.umd-DJQKlQjA.js";/* empty css                                                               */import"./dom-to-image-13VFuKJy.js";/* empty css                                                                   */const Z="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",F="https://api.spotify.com/v1";let S=null;const ee=async()=>{if(S)return S;const e=await fetch(Z);if(!e.ok)throw new Error("Could not fetch token");return S=await e.text(),S},M=async()=>({Authorization:`Bearer ${await ee()}`}),te=async e=>(await fetch(`${F}/tracks/${e}`,{headers:await M()})).json(),oe=async e=>(await fetch(`${F}/audio-features/${e}`,{headers:await M()})).json(),se=e=>{const a={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},i={0:"",1:"m"};return`${a[e.key]}${i[e.mode]}`},ne=async e=>{var r,n;const[a,i]=await Promise.all([te(e),oe(e)]);return{cover:(n=(r=a.album.images)==null?void 0:r[0])==null?void 0:n.url,name:a.name,artist:a.artists[0].name,album:a.album.name,href:a.external_urls.spotify,key:se(i),tempo:Math.round(i.tempo)}},ae=e=>{const a=e.match(/track\/(\w+)/);if(!a)throw new Error("Invalid URL");return a[1]},R=e=>(x("data-v-a28d277d"),e=e(),D(),e),re=R(()=>o("h1",null,"Link Spotify",-1)),le={class:"row"},ie={key:0,class:"changes"},ce=R(()=>o("h3",null,"Changes",-1)),de={class:"content"},ue={class:"material-symbols-rounded"},pe={class:"muted from"},me=R(()=>o("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),fe=["onClick"],ve={class:"actions"},ye=I({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(e,{expose:a}){E();const i=u(),r=u(),n=u({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),l=e,f=()=>{i.value.showModal(),m()},m=async()=>{l.song.spotify&&(r.value=await ne(ae(l.song.spotify)),r.value&&(n.value.artist={from:l.song.artist,to:r.value.artist},n.value.title={from:l.song.title,to:r.value.name},n.value.bpm={from:l.song.bpm,to:r.value.tempo},n.value.key={from:l.song.key,to:r.value.key},n.value.cover={from:l.song.cover,to:r.value.cover??""}))},d=s=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[s]??s,_=()=>{for(const s in n.value)l.song[s]=n.value[s].to},k=()=>{_(),i.value.close()};return a({show:f}),(s,v)=>(g(),b("dialog",{ref_key:"modal",ref:i},[re,o("div",null,[o("div",le,[p(B,{label:"Spotify URI",modelValue:e.song.spotify,"onUpdate:modelValue":v[0]||(v[0]=h=>e.song.spotify=h),onChange:m},null,8,["modelValue"]),o("span",{onClick:m,class:"material-symbols-rounded"}," refresh ")]),r.value?(g(),b("div",ie,[ce,o("div",de,[(g(!0),b(A,null,N(n.value,(h,y)=>(g(),b(A,null,[o("span",ue,$(d(y)),1),o("span",pe,$(h.from),1),me,p(B,{class:"to",modelValue:n.value[y].to,"onUpdate:modelValue":w=>n.value[y].to=w,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),o("span",{onClick:w=>delete n.value[y],class:"material-symbols-rounded"}," close ",8,fe)],64))),256))])])):O("",!0)]),o("div",ve,[p(C,{label:"Cancel",icon:"close",style:"red",onClick:v[1]||(v[1]=h=>i.value.close())}),p(C,{label:"Confirm",icon:"done",onClick:k,disabled:!r.value},null,8,["disabled"])])],512))}}),_e=L(ye,[["__scopeId","data-v-a28d277d"]]),j=e=>(x("data-v-277a352e"),e=e(),D(),e),he=j(()=>o("h1",null,"Keep Song",-1)),ge=j(()=>o("div",null,[o("p",null," You don't appear to have any content in this song. Do you want to keep it? ")],-1)),ke={class:"actions"},we=I({__name:"CleanupEmptySong",props:{song:{type:Object,required:!0}},emits:["close"],setup(e,{expose:a,emit:i}){const r=E(),n=u(),l=i,f=e,m=()=>{n.value.showModal()},d=()=>{n.value.close(),l("close")},_=()=>{r.removeSong(f.song),d()};return a({show:m}),(k,s)=>(g(),b("dialog",{ref_key:"modal",ref:n},[he,ge,o("div",ke,[p(C,{label:"Keep it",icon:"done",style:"green",onClick:s[0]||(s[0]=v=>d())}),p(C,{label:"Remove it",icon:"delete",style:"red",onClick:_})])],512))}}),be=L(we,[["__scopeId","data-v-277a352e"]]),K=e=>(x("data-v-944c51fd"),e=e(),D(),e),Se={class:"editor_container"},Ce=K(()=>o("span",{class:"material-symbols-rounded"},"arrow_back",-1)),$e=[Ce],Ie={class:"toolbar"},Ee=K(()=>o("div",{class:"divider"},null,-1)),xe=K(()=>o("div",{class:"divider"},null,-1)),De=I({__name:"index",setup(e){const a=E(),i=Y(),r=J(),n=W();let l=r.params.id;const f=u(),m=u(),d=u(!1),_=u();if(!l){const t=a.addEmptySong();n.push({path:`/editor/${t}`,replace:!0}),l=String(t)}const k=a.song(l);k||n.push("/");const s=u(k),v=()=>!(s.value.artist||s.value.title||s.value.instruments.length||s.value.sections.length||s.value.structure.length),h=()=>{var t;if(v()){(t=_.value)==null||t.show();return}n.back()},y=async()=>{await a.prepareRender();const t=await f.value.render();t&&(t.autoPrint(),window.open(t.output("bloburl"),"_blank"))},w=async()=>{await a.prepareRender();const t=await f.value.render();t&&t.save(`${s.value.title}.pdf`)},T=()=>{if(!s.value)return;const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s.value)),c=document.createElement("a");c.setAttribute("href",t),c.setAttribute("download",`${s.value.title}.chordsheets.json`),document.body.appendChild(c),c.click(),c.remove()},V=t=>{t.ctrlKey&&t.key==="s"?(t.preventDefault(),T()):t.ctrlKey&&t.shiftKey&&t.key==="S"?(t.preventDefault(),w()):t.ctrlKey&&t.key==="p"?(t.preventDefault(),y()):t.ctrlKey&&t.shiftKey&&t.key==="P"&&(t.preventDefault(),d.value=!d.value)};return H(()=>{window.addEventListener("keydown",V),i.songEdited(s.value.id)}),q(()=>{window.removeEventListener("keydown",V)}),(t,c)=>(g(),z(Q,{minWidth:300},{default:G(()=>[p(_e,{ref_key:"linkSpotify",ref:m,song:s.value},null,8,["song"]),p(be,{ref_key:"cleanupEmptySong",ref:_,song:s.value,onClose:c[0]||(c[0]=P=>t.$router.push("/browse"))},null,8,["song"]),o("div",Se,[o("a",{onClick:h,class:"back-button"},$e),o("div",Ie,[o("span",{class:"material-symbols-rounded",onClick:y,title:"Print (Ctrl+P)"}," print "),o("span",{class:"material-symbols-rounded",onClick:w,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),o("span",{class:"material-symbols-rounded",onClick:T,title:"Download as JSON (CTRL+S)"}," file_download "),Ee,o("span",{class:"material-symbols-rounded",onClick:c[1]||(c[1]=P=>{var U;return(U=m.value)==null?void 0:U.show()}),title:"Link Spotify"}," link "),xe,o("span",{class:"material-symbols-rounded",onClick:c[2]||(c[2]=P=>d.value=!d.value),title:"Preview (CTRL+SHIFT+P)"},$(d.value?"preview_off":"preview"),1)]),p(X,{ref_key:"editor",ref:f,song:s.value,printing:d.value},null,8,["song","printing"])])]),_:1}))}}),Me=L(De,[["__scopeId","data-v-944c51fd"]]);export{Me as default};
