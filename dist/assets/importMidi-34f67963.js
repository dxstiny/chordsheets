import{g as m}from"./_commonjsHelpers-12cdf5e8.js";var p={exports:{}};(function(u){(function(){const f=function(n){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!t.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(n.length&3));let s,d="",a,i,r=0;for(;r<n.length;)s=e.indexOf(n.charAt(r++))<<18|e.indexOf(n.charAt(r++))<<12|(a=e.indexOf(n.charAt(r++)))<<6|(i=e.indexOf(n.charAt(r++))),d+=a===64?String.fromCharCode(s>>16&255):i===64?String.fromCharCode(s>>16&255,s>>8&255):String.fromCharCode(s>>16&255,s>>8&255,s&255);return d},o={debug:!1,parse:function(n,e){if(n instanceof Uint8Array)return o.Uint8(n);if(typeof n=="string")return o.Base64(n);if(n instanceof HTMLElement&&n.type==="file")return o.addListener(n,e);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(n,e){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(n===void 0||!(n instanceof HTMLElement)||n.tagName!=="INPUT"||n.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;e=e||function(){},n.addEventListener("change",function(t){if(!t.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let s=new FileReader;s.readAsArrayBuffer(t.target.files[0]),s.onload=function(d){e(o.Uint8(new Uint8Array(d.target.result)))}})},Base64:function(n){n=String(n);let e=f(n),t=e.length,s=new Uint8Array(new ArrayBuffer(t));for(let d=0;d<t;d++)s[d]=e.charCodeAt(d);return o.Uint8(s)},Uint8:function(n){let e={data:null,pointer:0,movePointer:function(a){return this.pointer+=a,this.pointer},readInt:function(a){if(a=Math.min(a,this.data.byteLength-this.pointer),a<1)return-1;let i=0;if(a>1)for(let r=1;r<=a-1;r++)i+=this.data.getUint8(this.pointer)*Math.pow(256,a-r),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(a){let i="";for(let r=1;r<=a;r++)i+=String.fromCharCode(this.readInt(1));return i},readIntVLV:function(){let a=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)a=this.readInt(1);else{let i=[];for(;this.data.getUint8(this.pointer)>=128;)i.push(this.readInt(1)-128);let r=this.readInt(1);for(let l=1;l<=i.length;l++)a+=i[i.length-l]*Math.pow(128,l);a+=r}return a}};if(e.data=new DataView(n.buffer,n.byteOffset,n.byteLength),e.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;e.readInt(4);let t={};t.formatType=e.readInt(2),t.tracks=e.readInt(2),t.track=[];let s=e.readInt(1),d=e.readInt(1);s>=128?(t.timeDivision=[],t.timeDivision[0]=s-128,t.timeDivision[1]=d):t.timeDivision=s*256+d;for(let a=1;a<=t.tracks;a++){t.track[a-1]={event:[]};let i=e.readInt(4);if(i===-1)break;if(i!==1297379947)return!1;e.readInt(4);let r=0,l=!1,c,v;for(;!l&&(r++,t.track[a-1].event[r-1]={},t.track[a-1].event[r-1].deltaTime=e.readIntVLV(),c=e.readInt(1),c!==-1);)if(c>=128?v=c:(c=v,e.movePointer(-1)),c===255){t.track[a-1].event[r-1].type=255,t.track[a-1].event[r-1].metaType=e.readInt(1);let h=e.readIntVLV();switch(t.track[a-1].event[r-1].metaType){case 47:case-1:l=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:t.track[a-1].event[r-1].data=e.readStr(h);break;case 33:case 89:case 81:t.track[a-1].event[r-1].data=e.readInt(h);break;case 84:t.track[a-1].event[r-1].data=[],t.track[a-1].event[r-1].data[0]=e.readInt(1),t.track[a-1].event[r-1].data[1]=e.readInt(1),t.track[a-1].event[r-1].data[2]=e.readInt(1),t.track[a-1].event[r-1].data[3]=e.readInt(1),t.track[a-1].event[r-1].data[4]=e.readInt(1);break;case 88:t.track[a-1].event[r-1].data=[],t.track[a-1].event[r-1].data[0]=e.readInt(1),t.track[a-1].event[r-1].data[1]=e.readInt(1),t.track[a-1].event[r-1].data[2]=e.readInt(1),t.track[a-1].event[r-1].data[3]=e.readInt(1);break;default:this.customInterpreter!==null&&(t.track[a-1].event[r-1].data=this.customInterpreter(t.track[a-1].event[r-1].metaType,e,h)),(this.customInterpreter===null||t.track[a-1].event[r-1].data===!1)&&(e.readInt(h),t.track[a-1].event[r-1].data=e.readInt(h),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch(c=c.toString(16).split(""),c[1]||c.unshift("0"),t.track[a-1].event[r-1].type=parseInt(c[0],16),t.track[a-1].event[r-1].channel=parseInt(c[1],16),t.track[a-1].event[r-1].type){case 15:{if(this.customInterpreter!==null&&(t.track[a-1].event[r-1].data=this.customInterpreter(t.track[a-1].event[r-1].type,e,!1)),this.customInterpreter===null||t.track[a-1].event[r-1].data===!1){let h=e.readIntVLV();t.track[a-1].event[r-1].data=e.readInt(h),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer")}break}case 10:case 11:case 14:case 8:case 9:t.track[a-1].event[r-1].data=[],t.track[a-1].event[r-1].data[0]=e.readInt(1),t.track[a-1].event[r-1].data[1]=e.readInt(1);break;case 12:case 13:t.track[a-1].event[r-1].data=e.readInt(1);break;case-1:l=!0;break;default:if(this.customInterpreter!==null&&(t.track[a-1].event[r-1].data=this.customInterpreter(t.track[a-1].event[r-1].metaType,e,!1)),this.customInterpreter===null||t.track[a-1].event[r-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return t},customInterpreter:null};u.exports=o})()})(p);var I=p.exports;const k=m(I),x=u=>{var d,a;if(!u)return null;const{track:f}=u,o=f.filter(i=>i.event.some(r=>r.type===9||r.type===8)),n=(d=o[0].event.find(i=>i.metaType===3&&i.type===255))==null?void 0:d.data,e=(a=f.find(i=>i.event.some(r=>r.metaType===88&&r.type===255)))==null?void 0:a.event.map(i=>i.data).flat();if(!e)return null;const t={numerator:e[0],denominator:e[1],clocksPerTick:e[2],notesPerQuarter:e[3]},s=o.map(i=>i.event.filter(l=>l.type===9||l.type===8)).flat();return{name:n,signature:t,notes:y(s)}},w=async u=>new Promise((f,o)=>{const n=new FileReader;n.onload=e=>{if(!e.target){o("No target");return}const t=e.target.result,s=k.parse(t);f(x(s))},n.readAsDataURL(u)}),y=u=>{const f=[],o={};let n=0;for(const e of u)if(n+=e.deltaTime,e.type===9)o[e.data[0]]={start:n,velocity:e.data[1]};else if(e.type===8){const t=o[e.data[0]];if(!t)continue;const s=n-t.start;f.push({note:e.data[0],velocity:t.velocity,duration:s,start:t.start}),delete o[e.data[0]]}return f};export{w as m};
