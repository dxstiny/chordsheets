import{v as j,r as d,x as J,y as H,d as I,u as E,o as _,c as S,a as n,b as f,F as V,i as q,t as $,g as z,p as x,j as D,_ as L,z as G,A as W,e as Y,l as Q,B as X,n as Z}from"./main-Ff3BIIMF.js";import{M as ee}from"./MinWidth-BoBNvtH8.js";import{E as te}from"./Editor-CbYEmPdg.js";import{I as C}from"./IconButton-CgkpZHp-.js";import{T as B}from"./TextInput-D1EOUd74.js";import"./vuedraggable.umd-C9rQ_nbd.js";/* empty css                                                               */import"./dom-to-image-aRLAw4Vz.js";/* empty css                                                                   */const O="chordsheets.history",oe=j("history",()=>{const o=d(JSON.parse(localStorage.getItem(O)||"[]")),i=J(()=>JSON.stringify(o.value));return H(o,()=>{localStorage.setItem(O,i.value)},{deep:!0}),{history:o,songEdited:a=>{const l=new Date().toISOString();o.value=[{songId:a,date:l},...o.value.filter(p=>p.songId!==a).slice(0,9)]}}}),se="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",P="https://api.spotify.com/v1";let b=null;const ne=async()=>{if(b)return b;const e=await fetch(se);if(!e.ok)throw new Error("Could not fetch token");return b=await e.text(),b},U=async()=>({Authorization:`Bearer ${await ne()}`}),ae=async e=>(await fetch(`${P}/tracks/${e}`,{headers:await U()})).json(),re=async e=>(await fetch(`${P}/audio-features/${e}`,{headers:await U()})).json(),le=e=>{const o={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},i={0:"",1:"m"};return`${o[e.key]}${i[e.mode]}`},ie=async e=>{var r,a;const[o,i]=await Promise.all([ae(e),re(e)]);return{cover:(a=(r=o.album.images)==null?void 0:r[0])==null?void 0:a.url,name:o.name,artist:o.artists[0].name,album:o.album.name,href:o.external_urls.spotify,key:le(i),tempo:Math.round(i.tempo)}},ce=e=>{const o=e.match(/track\/(\w+)/);if(!o)throw new Error("Invalid URL");return o[1]},R=e=>(x("data-v-a28d277d"),e=e(),D(),e),ue=R(()=>n("h1",null,"Link Spotify",-1)),de={class:"row"},pe={key:0,class:"changes"},me=R(()=>n("h3",null,"Changes",-1)),fe={class:"content"},ve={class:"material-symbols-rounded"},ye={class:"muted from"},he=R(()=>n("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),ge=["onClick"],_e={class:"actions"},we=I({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(e,{expose:o}){E();const i=d(),r=d(),a=d({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),l=e,p=()=>{i.value.showModal(),m()},m=async()=>{l.song.spotify&&(r.value=await ie(ce(l.song.spotify)),r.value&&(a.value.artist={from:l.song.artist,to:r.value.artist},a.value.title={from:l.song.title,to:r.value.name},a.value.bpm={from:l.song.bpm,to:r.value.tempo},a.value.key={from:l.song.key,to:r.value.key},a.value.cover={from:l.song.cover,to:r.value.cover??""}))},u=s=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[s]??s,h=()=>{for(const s in a.value)l.song[s]=a.value[s].to},w=()=>{h(),i.value.close()};return o({show:p}),(s,v)=>(_(),S("dialog",{ref_key:"modal",ref:i},[ue,n("div",null,[n("div",de,[f(B,{label:"Spotify URI",modelValue:e.song.spotify,"onUpdate:modelValue":v[0]||(v[0]=g=>e.song.spotify=g),onChange:m},null,8,["modelValue"]),n("span",{onClick:m,class:"material-symbols-rounded"}," refresh ")]),r.value?(_(),S("div",pe,[me,n("div",fe,[(_(!0),S(V,null,q(a.value,(g,y)=>(_(),S(V,null,[n("span",ve,$(u(y)),1),n("span",ye,$(g.from),1),he,f(B,{class:"to",modelValue:a.value[y].to,"onUpdate:modelValue":k=>a.value[y].to=k,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),n("span",{onClick:k=>delete a.value[y],class:"material-symbols-rounded"}," close ",8,ge)],64))),256))])])):z("",!0)]),n("div",_e,[f(C,{label:"Cancel",icon:"close",style:"red",onClick:v[1]||(v[1]=g=>i.value.close())}),f(C,{label:"Confirm",icon:"done",onClick:w,disabled:!r.value},null,8,["disabled"])])],512))}}),ke=L(we,[["__scopeId","data-v-a28d277d"]]),F=e=>(x("data-v-277a352e"),e=e(),D(),e),Se=F(()=>n("h1",null,"Keep Song",-1)),be=F(()=>n("div",null,[n("p",null," You don't appear to have any content in this song. Do you want to keep it? ")],-1)),Ce={class:"actions"},$e=I({__name:"CleanupEmptySong",props:{song:{type:Object,required:!0}},emits:["close"],setup(e,{expose:o,emit:i}){const r=E(),a=d(),l=i,p=e,m=()=>{a.value.showModal()},u=()=>{a.value.close(),l("close")},h=()=>{r.removeSong(p.song),u()};return o({show:m}),(w,s)=>(_(),S("dialog",{ref_key:"modal",ref:a},[Se,be,n("div",Ce,[f(C,{label:"Keep it",icon:"done",style:"green",onClick:s[0]||(s[0]=v=>u())}),f(C,{label:"Remove it",icon:"delete",style:"red",onClick:h})])],512))}}),Ie=L($e,[["__scopeId","data-v-277a352e"]]),T=e=>(x("data-v-4327c76f"),e=e(),D(),e),Ee={class:"editor_container"},xe=T(()=>n("span",{class:"material-symbols-rounded"},"arrow_back",-1)),De=[xe],Le={class:"toolbar"},Re=T(()=>n("div",{class:"divider"},null,-1)),Te=T(()=>n("div",{class:"divider"},null,-1)),Ke=I({__name:"index",setup(e){const o=E(),i=oe(),r=X(),a=Z();let l=r.params.id;const p=d(),m=d(),u=d(!1),h=d();if(!l){const t=o.addEmptySong();a.push({path:`/editor/${t}`,replace:!0}),l=String(t)}const w=o.song(l);w||a.push("/");const s=d(w),v=()=>!(s.value.artist||s.value.title||s.value.instruments.length||s.value.sections.length||s.value.structure.length),g=()=>{var t;if(v()){(t=h.value)==null||t.show();return}a.back()},y=async()=>{await o.prepareRender();const t=await p.value.render();t&&(t.autoPrint(),window.open(t.output("bloburl"),"_blank"))},k=async()=>{await o.prepareRender();const t=await p.value.render();t&&t.save(`${s.value.title}.pdf`)},K=()=>{if(!s.value)return;const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s.value)),c=document.createElement("a");c.setAttribute("href",t),c.setAttribute("download",`${s.value.title}.chordsheets.json`),document.body.appendChild(c),c.click(),c.remove()},N=t=>{t.ctrlKey&&t.key==="s"?(t.preventDefault(),K()):t.ctrlKey&&t.shiftKey&&t.key==="S"?(t.preventDefault(),k()):t.ctrlKey&&t.key==="p"?(t.preventDefault(),y()):t.ctrlKey&&t.shiftKey&&t.key==="P"&&(t.preventDefault(),u.value=!u.value)};return G(()=>{window.addEventListener("keydown",N),i.songEdited(s.value.id),console.log("showing link spotify",s.value.spotify,s.value.title),s.value.spotify&&!s.value.title&&setTimeout(()=>{var t;return(t=m.value)==null?void 0:t.show()},100)}),W(()=>{window.removeEventListener("keydown",N)}),(t,c)=>(_(),Y(ee,{minWidth:300},{default:Q(()=>[f(ke,{ref_key:"linkSpotify",ref:m,song:s.value},null,8,["song"]),f(Ie,{ref_key:"cleanupEmptySong",ref:h,song:s.value,onClose:c[0]||(c[0]=A=>t.$router.push("/browse"))},null,8,["song"]),n("div",Ee,[n("a",{onClick:g,class:"back-button"},De),n("div",Le,[n("span",{class:"material-symbols-rounded",onClick:y,title:"Print (Ctrl+P)"}," print "),n("span",{class:"material-symbols-rounded",onClick:k,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),n("span",{class:"material-symbols-rounded",onClick:K,title:"Download as JSON (CTRL+S)"}," file_download "),Re,n("span",{class:"material-symbols-rounded",onClick:c[1]||(c[1]=A=>{var M;return(M=m.value)==null?void 0:M.show()}),title:"Link Spotify"}," link "),Te,n("span",{class:"material-symbols-rounded",onClick:c[2]||(c[2]=A=>u.value=!u.value),title:"Preview (CTRL+SHIFT+P)"},$(u.value?"preview_off":"preview"),1)]),f(te,{ref_key:"editor",ref:p,song:s.value,printing:u.value},null,8,["song","printing"])])]),_:1}))}}),je=L(Ke,[["__scopeId","data-v-4327c76f"]]);export{je as default};
