import{d as $,a as I,r as m,o as k,b,e as o,g as u,F as K,f as F,t as U,j as N,p as E,q as x,_ as D,s as P,v as O,h as q,w as H,C as G,l as J}from"./main-BUO_WqkU.js";import{u as W,E as z}from"./history-BCmMgOAf.js";import{M as Y}from"./MinWidth-CG_oC6Vd.js";import{I as C}from"./IconButton-CqZS3Xsm.js";import{T as A}from"./TextInput-DBDynWdP.js";import"./vuedraggable.umd-CNRkR5NR.js";import"./_commonjsHelpers-BosuxZz1.js";import"./dom-to-image-CF-nz2lh.js";const Q="https://europe-west6-elated-effect-396715.cloudfunctions.net/spotify/token",B="https://api.spotify.com/v1";let S=null;const X=async()=>{if(S)return S;const e=await fetch(Q);if(!e.ok)throw new Error("Could not fetch token");return S=await e.text(),S},M=async()=>({Authorization:`Bearer ${await X()}`}),Z=async e=>(await fetch(`${B}/tracks/${e}`,{headers:await M()})).json(),ee=async e=>(await fetch(`${B}/audio-features/${e}`,{headers:await M()})).json(),te=e=>{const n={0:"C",1:"C♯",2:"D",3:"D♯",4:"E",5:"F",6:"F♯",7:"G",8:"G♯",9:"A",10:"A♯",11:"B"},i={0:"",1:"m"};return`${n[e.key]}${i[e.mode]}`},oe=async e=>{var a,s;const[n,i]=await Promise.all([Z(e),ee(e)]);return{cover:(s=(a=n.album.images)==null?void 0:a[0])==null?void 0:s.url,name:n.name,artist:n.artists[0].name,album:n.album.name,href:n.external_urls.spotify,key:te(i),tempo:Math.round(i.tempo)}},se=e=>{const n=e.match(/track\/(\w+)/);if(!n)throw new Error("Invalid URL");return n[1]},L=e=>(E("data-v-a28d277d"),e=e(),x(),e),ne=L(()=>o("h1",null,"Link Spotify",-1)),ae={class:"row"},re={key:0,class:"changes"},le=L(()=>o("h3",null,"Changes",-1)),ie={class:"content"},ce={class:"material-symbols-rounded"},de={class:"muted from"},ue=L(()=>o("span",{class:"material-symbols-rounded"},"arrow_forward",-1)),pe=["onClick"],me={class:"actions"},fe=$({__name:"LinkSpotify",props:{song:{type:Object,required:!0}},setup(e,{expose:n}){I();const i=m(),a=m(),s=m({artist:{from:"",to:""},title:{from:"",to:""},bpm:{from:0,to:0},key:{from:"",to:""},cover:{from:"",to:""}}),l=e,f=()=>{i.value.showModal(),p()},p=async()=>{l.song.spotify&&(a.value=await oe(se(l.song.spotify)),a.value&&(s.value.artist={from:l.song.artist,to:a.value.artist},s.value.title={from:l.song.title,to:a.value.name},s.value.bpm={from:l.song.bpm,to:a.value.tempo},s.value.key={from:l.song.key,to:a.value.key},s.value.cover={from:l.song.cover,to:a.value.cover??""}))},v=c=>({bpm:"music_note",key:"piano",artist:"person",title:"title",cover:"image"})[c]??c,g=()=>{for(const c in s.value)l.song[c]=s.value[c].to},r=()=>{g(),i.value.close()};return n({show:f}),(c,y)=>(k(),b("dialog",{ref_key:"modal",ref:i},[ne,o("div",null,[o("div",ae,[u(A,{label:"Spotify URI",modelValue:e.song.spotify,"onUpdate:modelValue":y[0]||(y[0]=h=>e.song.spotify=h),onChange:p},null,8,["modelValue"]),o("span",{onClick:p,class:"material-symbols-rounded"}," refresh ")]),a.value?(k(),b("div",re,[le,o("div",ie,[(k(!0),b(K,null,F(s.value,(h,_)=>(k(),b(K,null,[o("span",ce,U(v(_)),1),o("span",de,U(h.from),1),ue,u(A,{class:"to",modelValue:s.value[_].to,"onUpdate:modelValue":w=>s.value[_].to=w,disabled:!0},null,8,["modelValue","onUpdate:modelValue"]),o("span",{onClick:w=>delete s.value[_],class:"material-symbols-rounded"}," close ",8,pe)],64))),256))])])):N("",!0)]),o("div",me,[u(C,{label:"Cancel",icon:"close",style:"red",onClick:y[1]||(y[1]=h=>i.value.close())}),u(C,{label:"Confirm",icon:"done",onClick:r,disabled:!a.value},null,8,["disabled"])])],512))}}),ve=D(fe,[["__scopeId","data-v-a28d277d"]]),T=e=>(E("data-v-277a352e"),e=e(),x(),e),ye=T(()=>o("h1",null,"Keep Song",-1)),he=T(()=>o("div",null,[o("p",null," You don't appear to have any content in this song. Do you want to keep it? ")],-1)),_e={class:"actions"},ge=$({__name:"CleanupEmptySong",props:{song:{type:Object,required:!0}},emits:["close"],setup(e,{expose:n,emit:i}){const a=I(),s=m(),l=i,f=e,p=()=>{s.value.showModal()},v=()=>{s.value.close(),l("close")},g=()=>{a.removeSong(f.song),v()};return n({show:p}),(r,c)=>(k(),b("dialog",{ref_key:"modal",ref:s},[ye,he,o("div",_e,[u(C,{label:"Keep it",icon:"done",style:"green",onClick:c[0]||(c[0]=y=>v())}),u(C,{label:"Remove it",icon:"delete",style:"red",onClick:g})])],512))}}),ke=D(ge,[["__scopeId","data-v-277a352e"]]),we=e=>(E("data-v-44e1c117"),e=e(),x(),e),be={class:"editor_container"},Se=we(()=>o("span",{class:"material-symbols-rounded"},"arrow_back",-1)),Ce=[Se],$e={class:"toolbar"},Ie=$({__name:"index",setup(e){const n=I(),i=W(),a=G(),s=J();let l=a.params.id;const f=m(),p=m(),v=m();if(!l){const t=n.addEmptySong();s.push({path:`/editor/${t}`,replace:!0}),l=String(t)}const g=n.song(l);g||s.push("/");const r=m(g),c=()=>!(r.value.artist||r.value.title||r.value.instruments.length||r.value.sections.length||r.value.structure.length),y=()=>{var t;if(c()){(t=v.value)==null||t.show();return}s.push("/")},h=async()=>{await n.prepareRender();const t=await f.value.render();t&&(t.autoPrint(),window.open(t.output("bloburl"),"_blank"))},_=async()=>{await n.prepareRender();const t=await f.value.render();t&&t.save(`${r.value.title}.pdf`)},w=()=>{if(!r.value)return;const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r.value)),d=document.createElement("a");d.setAttribute("href",t),d.setAttribute("download",`${r.value.title}.chordsheets.json`),document.body.appendChild(d),d.click(),d.remove()},R=t=>{t.ctrlKey&&t.key==="s"?(t.preventDefault(),w()):t.ctrlKey&&t.shiftKey&&t.key==="S"?(t.preventDefault(),_()):t.ctrlKey&&t.key==="p"&&(t.preventDefault(),h())};return P(()=>{window.addEventListener("keydown",R),i.songEdited(r.value.id)}),O(()=>{window.removeEventListener("keydown",R)}),(t,d)=>(k(),q(Y,{minWidth:300},{default:H(()=>[u(ve,{ref_key:"linkSpotify",ref:p,song:r.value},null,8,["song"]),u(ke,{ref_key:"cleanupEmptySong",ref:v,onClose:d[0]||(d[0]=j=>t.$router.push("/browse"))},null,512),o("div",be,[o("a",{onClick:y,class:"back-button"},Ce),o("div",$e,[o("span",{class:"material-symbols-rounded",onClick:h,title:"Print (Ctrl+P)"}," print "),o("span",{class:"material-symbols-rounded",onClick:_,title:"Download as PDF (CTRL+SHIFT+S)"}," picture_as_pdf "),o("span",{class:"material-symbols-rounded",onClick:w,title:"Download as JSON (CTRL+S)"}," file_download "),o("span",{class:"material-symbols-rounded",onClick:d[1]||(d[1]=j=>{var V;return(V=p.value)==null?void 0:V.show()}),title:"Link Spotify"}," link ")]),u(z,{ref_key:"editor",ref:f,song:r.value},null,8,["song"])])]),_:1}))}}),Ae=D(Ie,[["__scopeId","data-v-44e1c117"]]);export{Ae as default};
